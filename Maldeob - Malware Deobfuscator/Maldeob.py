import sys, argparse 

parser = argparse.ArgumentParser(description='Maltek Labs Replacer/Deobfuscator(WIP)')


#cmdline arguments to be passed
parser.add_argument('-a','--array', help='PATH to supplied array file.', required=True, type=str)
parser.add_argument("-i", '--input', help="PATH to malicious script.", required=True, type=str)
parser.add_argument("-o", "--output", help="PATH to output the completed file.", required=True, type=str)

#sets up arguments
args = vars(parser.parse_args())
array = args['array']
ifile = args['input']
ofile = args['output']


menu = print( 
                '''
                #######################################################################################
                #███╗   ███╗ █████╗ ██╗  ████████╗███████╗██╗  ██╗    ██╗      █████╗ ██████╗ ███████╗#
                #████╗ ████║██╔══██╗██║  ╚══██╔══╝██╔════╝██║ ██╔╝    ██║     ██╔══██╗██╔══██╗██╔════╝#
                #██╔████╔██║███████║██║     ██║   █████╗  █████╔╝     ██║     ███████║██████╔╝███████╗#
                #██║╚██╔╝██║██╔══██║██║     ██║   ██╔══╝  ██╔═██╗     ██║     ██╔══██║██╔══██╗╚════██║#
                #██║ ╚═╝ ██║██║  ██║███████╗██║   ███████╗██║  ██╗    ███████╗██║  ██║██████╔╝███████║#
                #╚═╝     ╚═╝╚═╝  ╚═╝╚══════╝╚═╝   ╚══════╝╚═╝  ╚═╝    ╚══════╝╚═╝  ╚═╝╚═════╝ ╚══════╝#
                #######################################################################################
                #                           https://maltek-labs.com                                   #
                #                       -Protection begins with analysis-                             #
                #                                                                                     #
                #               Maltek Labs Replacer/Deobfuscator Framework(WIP) v.1                  #
                #######################################################################################
                # optional arguments:                                                                 #
                # -h, --help            show this help message and exit.                              #
                # -a ARRAY, --Array ARRAY                                                             #
                #                    PATH to supplied array file.                                     #
                # -i INPUT, --Input INPUT                                                             #
                #                    PATH to malicious script.										  #
                # -o OUTPUT, --Output OUTPUT                                                          #
                #                    PATH to output the completed file.                               #
                #######################################################################################
                '''
                )



# Convert inputed Array to String
def ConvertArray():
    with open(array, 'r') as a:
        data_array = a.readlines()
    
    str = ''  

    for i in data_array: 
        str += i
    return str


# converts the inputed file to string
def ConvertList():
    with open(ifile, 'r') as f:
        text = f.readlines()
    
    str = ''  

    for i in text: 
        str += i
    return str


# replace & write function for data that was passed in -a (array) -i (inputfile)
def Array_Replace_Write():
    i = 0 
    b = 0        
    Converted_Text = ConvertList()   
    Converted_Array_Data = ConvertArray().splitlines()

    while i < len(Converted_Array_Data):
        item = VarName+"[{}]".format(b)
        text_after = Converted_Text.replace(item, Converted_Array_Data[i])
        Converted_Text = text_after
        
        i += 1
        b = str(int(b)+1)

    with open(ofile,'w') as w:
        w.writelines(Converted_Text)

    UnconvertedText = Converted_Text.find(VarName+'[')
    
    if UnconvertedText == -1:
        pass
    else:
        print("Not all array indexes were replaced. Some array indexs are being calulated with other variables.")
        print("")


        
if __name__ == "__main__":
    menu
    
    try:
        array
    except:
        print('')
        print('Array variable name not supplied. Exiting script. Please supply variable name to replace.')
        print('')
    else:
        print("You have selected the array option.")
        print("Please input the variable name of the array to replace:")
        VarName = input()
        print("########################################################")
        
        if VarName == '':
            print("You have entered an empty name.")
            print("Please enter a name of the array variable. Exiting.")
            print('')
            exit()

    try:
        Array_Replace_Write()
    except:
        print('')
        print('Something went wrong with the script. Did you supply the correct arguments including paths?')
        print('')
    else:
        print('')
        print('The file has been outputted to: '+ ofile) 
        print('')
